var Pt=Object.defineProperty;var Ht=(i,t,a)=>t in i?Pt(i,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[t]=a;var ce=(i,t,a)=>Ht(i,typeof t!="symbol"?t+"":t,a);import{R as zt,M as br,I as Gt,S as Tr,D as Zt,a as $r,H as Ie,F as Be,b as We,L as Ae,c as nr,d as Wt,C as Pe,e as Xr,O as jt,P as Yr,W as Vr,U as dr,f as $t,g as Xt,h as Er,T as je,i as Yt,j as Vt,k as qt,B as Kt,l as Qt,m as Mr,n as Jt,o as ea,p as Zr,q as ra,r as hr,N as ta,V as er,u as Xe,s as k,t as pr,v as aa,E as na,w as ia,x as sa,y as oa,z as vr,A as la,G as Wr,J as P,K as ca}from"./index-CI3Gl5t_.js";function Sr(){return Sr=Object.assign?Object.assign.bind():function(i){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var o in a)({}).hasOwnProperty.call(a,o)&&(i[o]=a[o])}return i},Sr.apply(null,arguments)}const qr=parseInt(zt.replace(/\D+/g,""));var Se=Uint8Array,He=Uint16Array,Ir=Uint32Array,Kr=new Se([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Qr=new Se([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ua=new Se([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Jr=function(i,t){for(var a=new He(31),o=0;o<31;++o)a[o]=t+=1<<i[o-1];for(var l=new Ir(a[30]),o=1;o<30;++o)for(var d=a[o];d<a[o+1];++d)l[d]=d-a[o]<<5|o;return[a,l]},et=Jr(Kr,2),rt=et[0],ha=et[1];rt[28]=258,ha[258]=28;var da=Jr(Qr,0),pa=da[0],xr=new He(32768);for(var re=0;re<32768;++re){var ke=(re&43690)>>>1|(re&21845)<<1;ke=(ke&52428)>>>2|(ke&13107)<<2,ke=(ke&61680)>>>4|(ke&3855)<<4,xr[re]=((ke&65280)>>>8|(ke&255)<<8)>>>1}var ar=(function(i,t,a){for(var o=i.length,l=0,d=new He(t);l<o;++l)++d[i[l]-1];var c=new He(t);for(l=0;l<t;++l)c[l]=c[l-1]+d[l-1]<<1;var w;if(a){w=new He(1<<t);var p=15-t;for(l=0;l<o;++l)if(i[l])for(var g=l<<4|i[l],b=t-i[l],C=c[i[l]-1]++<<b,T=C|(1<<b)-1;C<=T;++C)w[xr[C]>>>p]=g}else for(w=new He(o),l=0;l<o;++l)i[l]&&(w[l]=xr[c[i[l]-1]++]>>>15-i[l]);return w}),sr=new Se(288);for(var re=0;re<144;++re)sr[re]=8;for(var re=144;re<256;++re)sr[re]=9;for(var re=256;re<280;++re)sr[re]=7;for(var re=280;re<288;++re)sr[re]=8;var tt=new Se(32);for(var re=0;re<32;++re)tt[re]=5;var va=ar(sr,9,1),fa=ar(tt,5,1),mr=function(i){for(var t=i[0],a=1;a<i.length;++a)i[a]>t&&(t=i[a]);return t},Te=function(i,t,a){var o=t/8|0;return(i[o]|i[o+1]<<8)>>(t&7)&a},_r=function(i,t){var a=t/8|0;return(i[a]|i[a+1]<<8|i[a+2]<<16)>>(t&7)},ga=function(i){return(i/8|0)+(i&7&&1)},ma=function(i,t,a){(a==null||a>i.length)&&(a=i.length);var o=new(i instanceof He?He:i instanceof Ir?Ir:Se)(a-t);return o.set(i.subarray(t,a)),o},_a=function(i,t,a){var o=i.length;if(!o||a&&!a.l&&o<5)return t||new Se(0);var l=!t||a,d=!a||a.i;a||(a={}),t||(t=new Se(o*3));var c=function(X){var Fe=t.length;if(X>Fe){var Ue=new Se(Math.max(Fe*2,X));Ue.set(t),t=Ue}},w=a.f||0,p=a.p||0,g=a.b||0,b=a.l,C=a.d,T=a.m,O=a.n,N=o*8;do{if(!b){a.f=w=Te(i,p,1);var le=Te(i,p+1,3);if(p+=3,le)if(le==1)b=va,C=fa,T=9,O=5;else if(le==2){var ue=Te(i,p,31)+257,he=Te(i,p+10,15)+4,Z=ue+Te(i,p+5,31)+1;p+=14;for(var D=new Se(Z),ae=new Se(19),M=0;M<he;++M)ae[ua[M]]=Te(i,p+M*3,7);p+=he*3;for(var I=mr(ae),G=(1<<I)-1,$=ar(ae,I,1),M=0;M<Z;){var z=$[Te(i,p,G)];p+=z&15;var H=z>>>4;if(H<16)D[M++]=H;else{var W=0,A=0;for(H==16?(A=3+Te(i,p,3),p+=2,W=D[M-1]):H==17?(A=3+Te(i,p,7),p+=3):H==18&&(A=11+Te(i,p,127),p+=7);A--;)D[M++]=W}}var ne=D.subarray(0,ue),B=D.subarray(ue);T=mr(ne),O=mr(B),b=ar(ne,T,1),C=ar(B,O,1)}else throw"invalid block type";else{var H=ga(p)+4,q=i[H-4]|i[H-3]<<8,te=H+q;if(te>o){if(d)throw"unexpected EOF";break}l&&c(g+q),t.set(i.subarray(H,te),g),a.b=g+=q,a.p=p=te*8;continue}if(p>N){if(d)throw"unexpected EOF";break}}l&&c(g+131072);for(var xe=(1<<T)-1,ze=(1<<O)-1,be=p;;be=p){var W=b[_r(i,p)&xe],J=W>>>4;if(p+=W&15,p>N){if(d)throw"unexpected EOF";break}if(!W)throw"invalid length/literal";if(J<256)t[g++]=J;else if(J==256){be=p,b=null;break}else{var De=J-254;if(J>264){var M=J-257,ie=Kr[M];De=Te(i,p,(1<<ie)-1)+rt[M],p+=ie}var ve=C[_r(i,p)&ze],Re=ve>>>4;if(!ve)throw"invalid distance";p+=ve&15;var B=pa[Re];if(Re>3){var ie=Qr[Re];B+=_r(i,p)&(1<<ie)-1,p+=ie}if(p>N){if(d)throw"unexpected EOF";break}l&&c(g+131072);for(var Ye=g+De;g<Ye;g+=4)t[g]=t[g-B],t[g+1]=t[g+1-B],t[g+2]=t[g+2-B],t[g+3]=t[g+3-B];g=Ye}}a.l=b,a.p=be,a.b=g,b&&(w=1,a.m=T,a.d=C,a.n=O)}while(!w);return g==t.length?t:ma(t,0,g)},wa=new Se(0),ya=function(i){if((i[0]&15)!=8||i[0]>>>4>7||(i[0]<<8|i[1])%31)throw"invalid zlib data";if(i[1]&32)throw"invalid zlib data: preset dictionaries not supported"};function cr(i,t){return _a((ya(i),i.subarray(2,-4)),t)}var Ea=typeof TextDecoder<"u"&&new TextDecoder,Ma=0;try{Ea.decode(wa,{stream:!0}),Ma=1}catch{}const Sa=i=>i&&i.isCubeTexture;class Ia extends br{constructor(t,a){var o,l;const d=Sa(t),w=((l=d?(o=t.image[0])==null?void 0:o.width:t.image.width)!=null?l:1024)/4,p=Math.floor(Math.log2(w)),g=Math.pow(2,p),b=3*Math.max(g,112),C=4*g,T=[d?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/b}`,`#define CUBEUV_TEXEL_HEIGHT ${1/C}`,`#define CUBEUV_MAX_MIP ${p}.0`],O=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,N=T.join(`
`)+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${qr>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,le={map:{value:t},height:{value:(a==null?void 0:a.height)||15},radius:{value:(a==null?void 0:a.radius)||100}},H=new Gt(1,16),q=new Tr({uniforms:le,fragmentShader:N,vertexShader:O,side:Zt});super(H,q)}set radius(t){this.material.uniforms.radius.value=t}get radius(){return this.material.uniforms.radius.value}set height(t){this.material.uniforms.height.value=t}get height(){return this.material.uniforms.height.value}}class xa extends $r{constructor(t){super(t),this.type=Ie}parse(t){const c=function(M,I){switch(M){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(I||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(I||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(I||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(I||""))}},C=function(M,I,G){I=I||1024;let z=M.pos,W=-1,A=0,ne="",B=String.fromCharCode.apply(null,new Uint16Array(M.subarray(z,z+128)));for(;0>(W=B.indexOf(`
`))&&A<I&&z<M.byteLength;)ne+=B,A+=B.length,z+=128,B+=String.fromCharCode.apply(null,new Uint16Array(M.subarray(z,z+128)));return-1<W?(M.pos+=A+W+1,ne+B.slice(0,W)):!1},T=function(M){const I=/^#\?(\S+)/,G=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,$=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,z=/^\s*FORMAT=(\S+)\s*$/,W=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,A={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let ne,B;for((M.pos>=M.byteLength||!(ne=C(M)))&&c(1,"no header found"),(B=ne.match(I))||c(3,"bad initial token"),A.valid|=1,A.programtype=B[1],A.string+=ne+`
`;ne=C(M),ne!==!1;){if(A.string+=ne+`
`,ne.charAt(0)==="#"){A.comments+=ne+`
`;continue}if((B=ne.match(G))&&(A.gamma=parseFloat(B[1])),(B=ne.match($))&&(A.exposure=parseFloat(B[1])),(B=ne.match(z))&&(A.valid|=2,A.format=B[1]),(B=ne.match(W))&&(A.valid|=4,A.height=parseInt(B[1],10),A.width=parseInt(B[2],10)),A.valid&2&&A.valid&4)break}return A.valid&2||c(3,"missing format specifier"),A.valid&4||c(3,"missing image size specifier"),A},O=function(M,I,G){const $=I;if($<8||$>32767||M[0]!==2||M[1]!==2||M[2]&128)return new Uint8Array(M);$!==(M[2]<<8|M[3])&&c(3,"wrong scanline width");const z=new Uint8Array(4*I*G);z.length||c(4,"unable to allocate buffer space");let W=0,A=0;const ne=4*$,B=new Uint8Array(4),xe=new Uint8Array(ne);let ze=G;for(;ze>0&&A<M.byteLength;){A+4>M.byteLength&&c(1),B[0]=M[A++],B[1]=M[A++],B[2]=M[A++],B[3]=M[A++],(B[0]!=2||B[1]!=2||(B[2]<<8|B[3])!=$)&&c(3,"bad rgbe scanline format");let be=0,J;for(;be<ne&&A<M.byteLength;){J=M[A++];const ie=J>128;if(ie&&(J-=128),(J===0||be+J>ne)&&c(3,"bad scanline data"),ie){const ve=M[A++];for(let Re=0;Re<J;Re++)xe[be++]=ve}else xe.set(M.subarray(A,A+J),be),be+=J,A+=J}const De=$;for(let ie=0;ie<De;ie++){let ve=0;z[W]=xe[ie+ve],ve+=$,z[W+1]=xe[ie+ve],ve+=$,z[W+2]=xe[ie+ve],ve+=$,z[W+3]=xe[ie+ve],W+=4}ze--}return z},N=function(M,I,G,$){const z=M[I+3],W=Math.pow(2,z-128)/255;G[$+0]=M[I+0]*W,G[$+1]=M[I+1]*W,G[$+2]=M[I+2]*W,G[$+3]=1},le=function(M,I,G,$){const z=M[I+3],W=Math.pow(2,z-128)/255;G[$+0]=We.toHalfFloat(Math.min(M[I+0]*W,65504)),G[$+1]=We.toHalfFloat(Math.min(M[I+1]*W,65504)),G[$+2]=We.toHalfFloat(Math.min(M[I+2]*W,65504)),G[$+3]=We.toHalfFloat(1)},H=new Uint8Array(t);H.pos=0;const q=T(H),te=q.width,ue=q.height,he=O(H.subarray(H.pos),te,ue);let Z,D,ae;switch(this.type){case Be:ae=he.length/4;const M=new Float32Array(ae*4);for(let G=0;G<ae;G++)N(he,G*4,M,G*4);Z=M,D=Be;break;case Ie:ae=he.length/4;const I=new Uint16Array(ae*4);for(let G=0;G<ae;G++)le(he,G*4,I,G*4);Z=I,D=Ie;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:te,height:ue,data:Z,header:q.string,gamma:q.gamma,exposure:q.exposure,type:D}}setDataType(t){return this.type=t,this}load(t,a,o,l){function d(c,w){switch(c.type){case Be:case Ie:"colorSpace"in c?c.colorSpace="srgb-linear":c.encoding=3e3,c.minFilter=Ae,c.magFilter=Ae,c.generateMipmaps=!1,c.flipY=!0;break}a&&a(c,w)}return super.load(t,d,o,l)}}const rr=qr>=152;class ba extends $r{constructor(t){super(t),this.type=Ie}parse(t){const I=Math.pow(2.7182818,2.2);function G(e,r){for(var n=0,s=0;s<65536;++s)(s==0||e[s>>3]&1<<(s&7))&&(r[n++]=s);for(var u=n-1;n<65536;)r[n++]=0;return u}function $(e){for(var r=0;r<16384;r++)e[r]={},e[r].len=0,e[r].lit=0,e[r].p=null}const z={l:0,c:0,lc:0};function W(e,r,n,s,u){for(;n<e;)r=r<<8|zr(s,u),n+=8;n-=e,z.l=r>>n&(1<<e)-1,z.c=r,z.lc=n}const A=new Array(59);function ne(e){for(var r=0;r<=58;++r)A[r]=0;for(var r=0;r<65537;++r)A[e[r]]+=1;for(var n=0,r=58;r>0;--r){var s=n+A[r]>>1;A[r]=n,n=s}for(var r=0;r<65537;++r){var u=e[r];u>0&&(e[r]=u|A[u]++<<6)}}function B(e,r,n,s,u,h,f){for(var v=n,y=0,_=0;u<=h;u++){if(v.value-n.value>s)return!1;W(6,y,_,e,v);var E=z.l;if(y=z.c,_=z.lc,f[u]=E,E==63){if(v.value-n.value>s)throw"Something wrong with hufUnpackEncTable";W(8,y,_,e,v);var m=z.l+6;if(y=z.c,_=z.lc,u+m>h+1)throw"Something wrong with hufUnpackEncTable";for(;m--;)f[u++]=0;u--}else if(E>=59){var m=E-59+2;if(u+m>h+1)throw"Something wrong with hufUnpackEncTable";for(;m--;)f[u++]=0;u--}}ne(f)}function xe(e){return e&63}function ze(e){return e>>6}function be(e,r,n,s){for(;r<=n;r++){var u=ze(e[r]),h=xe(e[r]);if(u>>h)throw"Invalid table entry";if(h>14){var f=s[u>>h-14];if(f.len)throw"Invalid table entry";if(f.lit++,f.p){var v=f.p;f.p=new Array(f.lit);for(var y=0;y<f.lit-1;++y)f.p[y]=v[y]}else f.p=new Array(1);f.p[f.lit-1]=r}else if(h)for(var _=0,y=1<<14-h;y>0;y--){var f=s[(u<<14-h)+_];if(f.len||f.p)throw"Invalid table entry";f.len=h,f.lit=r,_++}}return!0}const J={c:0,lc:0};function De(e,r,n,s){e=e<<8|zr(n,s),r+=8,J.c=e,J.lc=r}const ie={c:0,lc:0};function ve(e,r,n,s,u,h,f,v,y,_){if(e==r){s<8&&(De(n,s,u,f),n=J.c,s=J.lc),s-=8;var E=n>>s,E=new Uint8Array([E])[0];if(y.value+E>_)return!1;for(var m=v[y.value-1];E-- >0;)v[y.value++]=m}else if(y.value<_)v[y.value++]=e;else return!1;ie.c=n,ie.lc=s}function Re(e){return e&65535}function Ye(e){var r=Re(e);return r>32767?r-65536:r}const X={a:0,b:0};function Fe(e,r){var n=Ye(e),s=Ye(r),u=s,h=n+(u&1)+(u>>1),f=h,v=h-u;X.a=f,X.b=v}function Ue(e,r){var n=Re(e),s=Re(r),u=n-(s>>1)&65535,h=s+u-32768&65535;X.a=h,X.b=u}function ct(e,r,n,s,u,h,f){for(var v=f<16384,y=n>u?u:n,_=1,E;_<=y;)_<<=1;for(_>>=1,E=_,_>>=1;_>=1;){for(var m=0,oe=m+h*(u-E),x=h*_,R=h*E,F=s*_,U=s*E,Y,K,de,me;m<=oe;m+=R){for(var Q=m,Ce=m+s*(n-E);Q<=Ce;Q+=U){var ee=Q+F,pe=Q+x,Oe=pe+F;v?(Fe(e[Q+r],e[pe+r]),Y=X.a,de=X.b,Fe(e[ee+r],e[Oe+r]),K=X.a,me=X.b,Fe(Y,K),e[Q+r]=X.a,e[ee+r]=X.b,Fe(de,me),e[pe+r]=X.a,e[Oe+r]=X.b):(Ue(e[Q+r],e[pe+r]),Y=X.a,de=X.b,Ue(e[ee+r],e[Oe+r]),K=X.a,me=X.b,Ue(Y,K),e[Q+r]=X.a,e[ee+r]=X.b,Ue(de,me),e[pe+r]=X.a,e[Oe+r]=X.b)}if(n&_){var pe=Q+x;v?Fe(e[Q+r],e[pe+r]):Ue(e[Q+r],e[pe+r]),Y=X.a,e[pe+r]=X.b,e[Q+r]=Y}}if(u&_)for(var Q=m,Ce=m+s*(n-E);Q<=Ce;Q+=U){var ee=Q+F;v?Fe(e[Q+r],e[ee+r]):Ue(e[Q+r],e[ee+r]),Y=X.a,e[ee+r]=X.b,e[Q+r]=Y}E=_,_>>=1}return m}function ut(e,r,n,s,u,h,f,v,y,_){for(var E=0,m=0,oe=v,x=Math.trunc(u.value+(h+7)/8);u.value<x;)for(De(E,m,n,u),E=J.c,m=J.lc;m>=14;){var R=E>>m-14&16383,F=r[R];if(F.len)m-=F.len,ve(F.lit,f,E,m,n,s,u,y,_,oe),E=ie.c,m=ie.lc;else{if(!F.p)throw"hufDecode issues";var U;for(U=0;U<F.lit;U++){for(var Y=xe(e[F.p[U]]);m<Y&&u.value<x;)De(E,m,n,u),E=J.c,m=J.lc;if(m>=Y&&ze(e[F.p[U]])==(E>>m-Y&(1<<Y)-1)){m-=Y,ve(F.p[U],f,E,m,n,s,u,y,_,oe),E=ie.c,m=ie.lc;break}}if(U==F.lit)throw"hufDecode issues"}}var K=8-h&7;for(E>>=K,m-=K;m>0;){var F=r[E<<14-m&16383];if(F.len)m-=F.len,ve(F.lit,f,E,m,n,s,u,y,_,oe),E=ie.c,m=ie.lc;else throw"hufDecode issues"}return!0}function Br(e,r,n,s,u,h){var f={value:0},v=n.value,y=_e(r,n),_=_e(r,n);n.value+=4;var E=_e(r,n);if(n.value+=4,y<0||y>=65537||_<0||_>=65537)throw"Something wrong with HUF_ENCSIZE";var m=new Array(65537),oe=new Array(16384);$(oe);var x=s-(n.value-v);if(B(e,r,n,x,y,_,m),E>8*(s-(n.value-v)))throw"Something wrong with hufUncompress";be(m,y,_,oe),ut(m,oe,e,r,n,E,_,h,u,f)}function ht(e,r,n){for(var s=0;s<n;++s)r[s]=e[r[s]]}function Dr(e){for(var r=1;r<e.length;r++){var n=e[r-1]+e[r]-128;e[r]=n}}function Lr(e,r){for(var n=0,s=Math.floor((e.length+1)/2),u=0,h=e.length-1;!(u>h||(r[u++]=e[n++],u>h));)r[u++]=e[s++]}function kr(e){for(var r=e.byteLength,n=new Array,s=0,u=new DataView(e);r>0;){var h=u.getInt8(s++);if(h<0){var f=-h;r-=f+1;for(var v=0;v<f;v++)n.push(u.getUint8(s++))}else{var f=h;r-=2;for(var y=u.getUint8(s++),v=0;v<f+1;v++)n.push(y)}}return n}function dt(e,r,n,s,u,h){var ee=new DataView(h.buffer),f=n[e.idx[0]].width,v=n[e.idx[0]].height,y=3,_=Math.floor(f/8),E=Math.ceil(f/8),m=Math.ceil(v/8),oe=f-(E-1)*8,x=v-(m-1)*8,R={value:0},F=new Array(y),U=new Array(y),Y=new Array(y),K=new Array(y),de=new Array(y);for(let V=0;V<y;++V)de[V]=r[e.idx[V]],F[V]=V<1?0:F[V-1]+E*m,U[V]=new Float32Array(64),Y[V]=new Uint16Array(64),K[V]=new Uint16Array(E*64);for(let V=0;V<m;++V){var me=8;V==m-1&&(me=x);var Q=8;for(let se=0;se<E;++se){se==E-1&&(Q=oe);for(let j=0;j<y;++j)Y[j].fill(0),Y[j][0]=u[F[j]++],pt(R,s,Y[j]),vt(Y[j],U[j]),ft(U[j]);gt(U);for(let j=0;j<y;++j)mt(U[j],K[j],se*64)}let ge=0;for(let se=0;se<y;++se){const j=n[e.idx[se]].type;for(let Me=8*V;Me<8*V+me;++Me){ge=de[se][Me];for(let Ge=0;Ge<_;++Ge){const we=Ge*64+(Me&7)*8;ee.setUint16(ge+0*j,K[se][we+0],!0),ee.setUint16(ge+2*j,K[se][we+1],!0),ee.setUint16(ge+4*j,K[se][we+2],!0),ee.setUint16(ge+6*j,K[se][we+3],!0),ee.setUint16(ge+8*j,K[se][we+4],!0),ee.setUint16(ge+10*j,K[se][we+5],!0),ee.setUint16(ge+12*j,K[se][we+6],!0),ee.setUint16(ge+14*j,K[se][we+7],!0),ge+=16*j}}if(_!=E)for(let Me=8*V;Me<8*V+me;++Me){const Ge=de[se][Me]+8*_*2*j,we=_*64+(Me&7)*8;for(let Le=0;Le<Q;++Le)ee.setUint16(Ge+Le*2*j,K[se][we+Le],!0)}}}for(var Ce=new Uint16Array(f),ee=new DataView(h.buffer),pe=0;pe<y;++pe){n[e.idx[pe]].decoded=!0;var Oe=n[e.idx[pe]].type;if(n[pe].type==2)for(var Je=0;Je<v;++Je){const V=de[pe][Je];for(var Ee=0;Ee<f;++Ee)Ce[Ee]=ee.getUint16(V+Ee*2*Oe,!0);for(var Ee=0;Ee<f;++Ee)ee.setFloat32(V+Ee*2*Oe,S(Ce[Ee]),!0)}}}function pt(e,r,n){for(var s,u=1;u<64;)s=r[e.value],s==65280?u=64:s>>8==255?u+=s&255:(n[u]=s,u++),e.value++}function vt(e,r){r[0]=S(e[0]),r[1]=S(e[1]),r[2]=S(e[5]),r[3]=S(e[6]),r[4]=S(e[14]),r[5]=S(e[15]),r[6]=S(e[27]),r[7]=S(e[28]),r[8]=S(e[2]),r[9]=S(e[4]),r[10]=S(e[7]),r[11]=S(e[13]),r[12]=S(e[16]),r[13]=S(e[26]),r[14]=S(e[29]),r[15]=S(e[42]),r[16]=S(e[3]),r[17]=S(e[8]),r[18]=S(e[12]),r[19]=S(e[17]),r[20]=S(e[25]),r[21]=S(e[30]),r[22]=S(e[41]),r[23]=S(e[43]),r[24]=S(e[9]),r[25]=S(e[11]),r[26]=S(e[18]),r[27]=S(e[24]),r[28]=S(e[31]),r[29]=S(e[40]),r[30]=S(e[44]),r[31]=S(e[53]),r[32]=S(e[10]),r[33]=S(e[19]),r[34]=S(e[23]),r[35]=S(e[32]),r[36]=S(e[39]),r[37]=S(e[45]),r[38]=S(e[52]),r[39]=S(e[54]),r[40]=S(e[20]),r[41]=S(e[22]),r[42]=S(e[33]),r[43]=S(e[38]),r[44]=S(e[46]),r[45]=S(e[51]),r[46]=S(e[55]),r[47]=S(e[60]),r[48]=S(e[21]),r[49]=S(e[34]),r[50]=S(e[37]),r[51]=S(e[47]),r[52]=S(e[50]),r[53]=S(e[56]),r[54]=S(e[59]),r[55]=S(e[61]),r[56]=S(e[35]),r[57]=S(e[36]),r[58]=S(e[48]),r[59]=S(e[49]),r[60]=S(e[57]),r[61]=S(e[58]),r[62]=S(e[62]),r[63]=S(e[63])}function ft(e){const r=.5*Math.cos(.7853975),n=.5*Math.cos(3.14159/16),s=.5*Math.cos(3.14159/8),u=.5*Math.cos(3*3.14159/16),h=.5*Math.cos(5*3.14159/16),f=.5*Math.cos(3*3.14159/8),v=.5*Math.cos(7*3.14159/16);for(var y=new Array(4),_=new Array(4),E=new Array(4),m=new Array(4),oe=0;oe<8;++oe){var x=oe*8;y[0]=s*e[x+2],y[1]=f*e[x+2],y[2]=s*e[x+6],y[3]=f*e[x+6],_[0]=n*e[x+1]+u*e[x+3]+h*e[x+5]+v*e[x+7],_[1]=u*e[x+1]-v*e[x+3]-n*e[x+5]-h*e[x+7],_[2]=h*e[x+1]-n*e[x+3]+v*e[x+5]+u*e[x+7],_[3]=v*e[x+1]-h*e[x+3]+u*e[x+5]-n*e[x+7],E[0]=r*(e[x+0]+e[x+4]),E[3]=r*(e[x+0]-e[x+4]),E[1]=y[0]+y[3],E[2]=y[1]-y[2],m[0]=E[0]+E[1],m[1]=E[3]+E[2],m[2]=E[3]-E[2],m[3]=E[0]-E[1],e[x+0]=m[0]+_[0],e[x+1]=m[1]+_[1],e[x+2]=m[2]+_[2],e[x+3]=m[3]+_[3],e[x+4]=m[3]-_[3],e[x+5]=m[2]-_[2],e[x+6]=m[1]-_[1],e[x+7]=m[0]-_[0]}for(var R=0;R<8;++R)y[0]=s*e[16+R],y[1]=f*e[16+R],y[2]=s*e[48+R],y[3]=f*e[48+R],_[0]=n*e[8+R]+u*e[24+R]+h*e[40+R]+v*e[56+R],_[1]=u*e[8+R]-v*e[24+R]-n*e[40+R]-h*e[56+R],_[2]=h*e[8+R]-n*e[24+R]+v*e[40+R]+u*e[56+R],_[3]=v*e[8+R]-h*e[24+R]+u*e[40+R]-n*e[56+R],E[0]=r*(e[R]+e[32+R]),E[3]=r*(e[R]-e[32+R]),E[1]=y[0]+y[3],E[2]=y[1]-y[2],m[0]=E[0]+E[1],m[1]=E[3]+E[2],m[2]=E[3]-E[2],m[3]=E[0]-E[1],e[0+R]=m[0]+_[0],e[8+R]=m[1]+_[1],e[16+R]=m[2]+_[2],e[24+R]=m[3]+_[3],e[32+R]=m[3]-_[3],e[40+R]=m[2]-_[2],e[48+R]=m[1]-_[1],e[56+R]=m[0]-_[0]}function gt(e){for(var r=0;r<64;++r){var n=e[0][r],s=e[1][r],u=e[2][r];e[0][r]=n+1.5747*u,e[1][r]=n-.1873*s-.4682*u,e[2][r]=n+1.8556*s}}function mt(e,r,n){for(var s=0;s<64;++s)r[n+s]=We.toHalfFloat(_t(e[s]))}function _t(e){return e<=1?Math.sign(e)*Math.pow(Math.abs(e),2.2):Math.sign(e)*Math.pow(I,Math.abs(e)-1)}function Pr(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function wt(e){var r=e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size),n=new Uint8Array(kr(r)),s=new Uint8Array(n.length);return Dr(n),Lr(n,s),new DataView(s.buffer)}function gr(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),n=cr(r),s=new Uint8Array(n.length);return Dr(n),Lr(n,s),new DataView(s.buffer)}function yt(e){for(var r=e.viewer,n={value:e.offset.value},s=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),u=new Uint8Array(8192),h=0,f=new Array(e.channels),v=0;v<e.channels;v++)f[v]={},f[v].start=h,f[v].end=f[v].start,f[v].nx=e.width,f[v].ny=e.lines,f[v].size=e.type,h+=f[v].nx*f[v].ny*f[v].size;var y=qe(r,n),_=qe(r,n);if(_>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(y<=_)for(var v=0;v<_-y+1;v++)u[v+y]=Ze(r,n);var E=new Uint16Array(65536),m=G(u,E),oe=_e(r,n);Br(e.array,r,n,oe,s,h);for(var v=0;v<e.channels;++v)for(var x=f[v],R=0;R<f[v].size;++R)ct(s,x.start+R,x.nx,x.size,x.ny,x.nx*x.size,m);ht(E,s,h);for(var F=0,U=new Uint8Array(s.buffer.byteLength),Y=0;Y<e.lines;Y++)for(var K=0;K<e.channels;K++){var x=f[K],de=x.nx*x.size,me=new Uint8Array(s.buffer,x.end*2,de*2);U.set(me,F),F+=de*2,x.end+=de}return new DataView(U.buffer)}function Et(e){var r=e.array.slice(e.offset.value,e.offset.value+e.size),n=cr(r);const s=e.lines*e.channels*e.width,u=e.type==1?new Uint16Array(s):new Uint32Array(s);let h=0,f=0;const v=new Array(4);for(let y=0;y<e.lines;y++)for(let _=0;_<e.channels;_++){let E=0;switch(e.type){case 1:v[0]=h,v[1]=v[0]+e.width,h=v[1]+e.width;for(let m=0;m<e.width;++m){const oe=n[v[0]++]<<8|n[v[1]++];E+=oe,u[f]=E,f++}break;case 2:v[0]=h,v[1]=v[0]+e.width,v[2]=v[1]+e.width,h=v[2]+e.width;for(let m=0;m<e.width;++m){const oe=n[v[0]++]<<24|n[v[1]++]<<16|n[v[2]++]<<8;E+=oe,u[f]=E,f++}break}}return new DataView(u.buffer)}function Hr(e){var r=e.viewer,n={value:e.offset.value},s=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),u={version:ye(r,n),unknownUncompressedSize:ye(r,n),unknownCompressedSize:ye(r,n),acCompressedSize:ye(r,n),dcCompressedSize:ye(r,n),rleCompressedSize:ye(r,n),rleUncompressedSize:ye(r,n),rleRawSize:ye(r,n),totalAcUncompressedCount:ye(r,n),totalDcUncompressedCount:ye(r,n),acCompression:ye(r,n)};if(u.version<2)throw"EXRLoader.parse: "+Qe.compression+" version "+u.version+" is unsupported";for(var h=new Array,f=qe(r,n)-2;f>0;){var v=or(r.buffer,n),y=Ze(r,n),_=y>>2&3,E=(y>>4)-1,m=new Int8Array([E])[0],oe=Ze(r,n);h.push({name:v,index:m,type:oe,compression:_}),f-=v.length+3}for(var x=Qe.channels,R=new Array(e.channels),F=0;F<e.channels;++F){var U=R[F]={},Y=x[F];U.name=Y.name,U.compression=0,U.decoded=!1,U.type=Y.pixelType,U.pLinear=Y.pLinear,U.width=e.width,U.height=e.lines}for(var K={idx:new Array(3)},de=0;de<e.channels;++de)for(var U=R[de],F=0;F<h.length;++F){var me=h[F];U.name==me.name&&(U.compression=me.compression,me.index>=0&&(K.idx[me.index]=de),U.offset=de)}if(u.acCompressedSize>0)switch(u.acCompression){case 0:var ee=new Uint16Array(u.totalAcUncompressedCount);Br(e.array,r,n,u.acCompressedSize,ee,u.totalAcUncompressedCount);break;case 1:var Q=e.array.slice(n.value,n.value+u.totalAcUncompressedCount),Ce=cr(Q),ee=new Uint16Array(Ce.buffer);n.value+=u.totalAcUncompressedCount;break}if(u.dcCompressedSize>0){var pe={array:e.array,offset:n,size:u.dcCompressedSize},Oe=new Uint16Array(gr(pe).buffer);n.value+=u.dcCompressedSize}if(u.rleRawSize>0){var Q=e.array.slice(n.value,n.value+u.rleCompressedSize),Ce=cr(Q),Je=kr(Ce.buffer);n.value+=u.rleCompressedSize}for(var Ee=0,V=new Array(R.length),F=0;F<V.length;++F)V[F]=new Array;for(var ge=0;ge<e.lines;++ge)for(var se=0;se<R.length;++se)V[se].push(Ee),Ee+=R[se].width*e.type*2;dt(K,V,R,ee,Oe,s);for(var F=0;F<R.length;++F){var U=R[F];if(!U.decoded)switch(U.compression){case 2:for(var j=0,Me=0,ge=0;ge<e.lines;++ge){for(var Ge=V[F][j],we=0;we<U.width;++we){for(var Le=0;Le<2*U.type;++Le)s[Ge++]=Je[Me+Le*U.width*U.height];Me++}j++}break;case 1:default:throw"EXRLoader.parse: unsupported channel compression"}}return new DataView(s.buffer)}function or(e,r){for(var n=new Uint8Array(e),s=0;n[r.value+s]!=0;)s+=1;var u=new TextDecoder().decode(n.slice(r.value,r.value+s));return r.value=r.value+s+1,u}function Mt(e,r,n){var s=new TextDecoder().decode(new Uint8Array(e).slice(r.value,r.value+n));return r.value=r.value+n,s}function St(e,r){var n=Ve(e,r),s=_e(e,r);return[n,s]}function It(e,r){var n=_e(e,r),s=_e(e,r);return[n,s]}function Ve(e,r){var n=e.getInt32(r.value,!0);return r.value=r.value+4,n}function _e(e,r){var n=e.getUint32(r.value,!0);return r.value=r.value+4,n}function zr(e,r){var n=e[r.value];return r.value=r.value+1,n}function Ze(e,r){var n=e.getUint8(r.value);return r.value=r.value+1,n}const ye=function(e,r){let n;return"getBigInt64"in DataView.prototype?n=Number(e.getBigInt64(r.value,!0)):n=e.getUint32(r.value+4,!0)+Number(e.getUint32(r.value,!0)<<32),r.value+=8,n};function fe(e,r){var n=e.getFloat32(r.value,!0);return r.value+=4,n}function xt(e,r){return We.toHalfFloat(fe(e,r))}function S(e){var r=(e&31744)>>10,n=e&1023;return(e>>15?-1:1)*(r?r===31?n?NaN:1/0:Math.pow(2,r-15)*(1+n/1024):6103515625e-14*(n/1024))}function qe(e,r){var n=e.getUint16(r.value,!0);return r.value+=2,n}function bt(e,r){return S(qe(e,r))}function Tt(e,r,n,s){for(var u=n.value,h=[];n.value<u+s-1;){var f=or(r,n),v=Ve(e,n),y=Ze(e,n);n.value+=3;var _=Ve(e,n),E=Ve(e,n);h.push({name:f,pixelType:v,pLinear:y,xSampling:_,ySampling:E})}return n.value+=1,h}function Rt(e,r){var n=fe(e,r),s=fe(e,r),u=fe(e,r),h=fe(e,r),f=fe(e,r),v=fe(e,r),y=fe(e,r),_=fe(e,r);return{redX:n,redY:s,greenX:u,greenY:h,blueX:f,blueY:v,whiteX:y,whiteY:_}}function Ct(e,r){var n=["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"],s=Ze(e,r);return n[s]}function At(e,r){var n=_e(e,r),s=_e(e,r),u=_e(e,r),h=_e(e,r);return{xMin:n,yMin:s,xMax:u,yMax:h}}function Ft(e,r){var n=["INCREASING_Y"],s=Ze(e,r);return n[s]}function Ut(e,r){var n=fe(e,r),s=fe(e,r);return[n,s]}function Ot(e,r){var n=fe(e,r),s=fe(e,r),u=fe(e,r);return[n,s,u]}function Nt(e,r,n,s,u){if(s==="string"||s==="stringvector"||s==="iccProfile")return Mt(r,n,u);if(s==="chlist")return Tt(e,r,n,u);if(s==="chromaticities")return Rt(e,n);if(s==="compression")return Ct(e,n);if(s==="box2i")return At(e,n);if(s==="lineOrder")return Ft(e,n);if(s==="float")return fe(e,n);if(s==="v2f")return Ut(e,n);if(s==="v3f")return Ot(e,n);if(s==="int")return Ve(e,n);if(s==="rational")return St(e,n);if(s==="timecode")return It(e,n);if(s==="preview")return n.value+=u,"skipped";n.value+=u}function Bt(e,r,n){const s={};if(e.getUint32(0,!0)!=20000630)throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";s.version=e.getUint8(4);const u=e.getUint8(5);s.spec={singleTile:!!(u&2),longName:!!(u&4),deepFormat:!!(u&8),multiPart:!!(u&16)},n.value=8;for(var h=!0;h;){var f=or(r,n);if(f==0)h=!1;else{var v=or(r,n),y=_e(e,n),_=Nt(e,r,n,v,y);_===void 0?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${v}'.`):s[f]=_}}if((u&-5)!=0)throw console.error("EXRHeader:",s),"THREE.EXRLoader: provided file is currently unsupported.";return s}function Dt(e,r,n,s,u){const h={size:0,viewer:r,array:n,offset:s,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,[rr?"colorSpace":"encoding"]:null};switch(e.compression){case"NO_COMPRESSION":h.lines=1,h.uncompress=Pr;break;case"RLE_COMPRESSION":h.lines=1,h.uncompress=wt;break;case"ZIPS_COMPRESSION":h.lines=1,h.uncompress=gr;break;case"ZIP_COMPRESSION":h.lines=16,h.uncompress=gr;break;case"PIZ_COMPRESSION":h.lines=32,h.uncompress=yt;break;case"PXR24_COMPRESSION":h.lines=16,h.uncompress=Et;break;case"DWAA_COMPRESSION":h.lines=32,h.uncompress=Hr;break;case"DWAB_COMPRESSION":h.lines=256,h.uncompress=Hr;break;default:throw"EXRLoader.parse: "+e.compression+" is unsupported"}if(h.scanlineBlockSize=h.lines,h.type==1)switch(u){case Be:h.getter=bt,h.inputSize=2;break;case Ie:h.getter=qe,h.inputSize=2;break}else if(h.type==2)switch(u){case Be:h.getter=fe,h.inputSize=4;break;case Ie:h.getter=xt,h.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+h.type+" for "+e.compression+".";h.blockCount=(e.dataWindow.yMax+1)/h.scanlineBlockSize;for(var f=0;f<h.blockCount;f++)ye(r,s);h.outputChannels=h.channels==3?4:h.channels;const v=h.width*h.height*h.outputChannels;switch(u){case Be:h.byteArray=new Float32Array(v),h.channels<h.outputChannels&&h.byteArray.fill(1,0,v);break;case Ie:h.byteArray=new Uint16Array(v),h.channels<h.outputChannels&&h.byteArray.fill(15360,0,v);break;default:console.error("THREE.EXRLoader: unsupported type: ",u);break}return h.bytesPerLine=h.width*h.inputSize*h.channels,h.outputChannels==4?h.format=nr:h.format=Wt,rr?h.colorSpace="srgb-linear":h.encoding=3e3,h}const lr=new DataView(t),Lt=new Uint8Array(t),Ke={value:0},Qe=Bt(lr,t,Ke),L=Dt(Qe,lr,Lt,Ke,this.type),Gr={value:0},kt={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<L.height/L.scanlineBlockSize;e++){const r=_e(lr,Ke);L.size=_e(lr,Ke),L.lines=r+L.scanlineBlockSize>L.height?L.height-r:L.scanlineBlockSize;const s=L.size<L.lines*L.bytesPerLine?L.uncompress(L):Pr(L);Ke.value+=L.size;for(let u=0;u<L.scanlineBlockSize;u++){const h=u+e*L.scanlineBlockSize;if(h>=L.height)break;for(let f=0;f<L.channels;f++){const v=kt[Qe.channels[f].name];for(let y=0;y<L.width;y++){Gr.value=(u*(L.channels*L.width)+f*L.width+y)*L.inputSize;const _=(L.height-1-h)*(L.width*L.outputChannels)+y*L.outputChannels+v;L.byteArray[_]=L.getter(s,Gr)}}}}return{header:Qe,width:L.width,height:L.height,data:L.byteArray,format:L.format,[rr?"colorSpace":"encoding"]:L[rr?"colorSpace":"encoding"],type:this.type}}setDataType(t){return this.type=t,this}load(t,a,o,l){function d(c,w){rr?c.colorSpace=w.colorSpace:c.encoding=w.encoding,c.minFilter=Ae,c.magFilter=Ae,c.generateMipmaps=!1,c.flipY=!1,a&&a(c,w)}return super.load(t,d,o,l)}}const at=(i,t,a)=>{let o;switch(i){case Mr:o=new Uint8ClampedArray(t*a*4);break;case Ie:o=new Uint16Array(t*a*4);break;case Qt:o=new Uint32Array(t*a*4);break;case Kt:o=new Int8Array(t*a*4);break;case qt:o=new Int16Array(t*a*4);break;case Vt:o=new Int32Array(t*a*4);break;case Be:o=new Float32Array(t*a*4);break;default:throw new Error("Unsupported data type")}return o};let ur;const Ta=(i,t,a,o)=>{if(ur!==void 0)return ur;const l=new Vr(1,1,o);t.setRenderTarget(l);const d=new br(new Yr,new Yt({color:16777215}));t.render(d,a),t.setRenderTarget(null);const c=at(i,l.width,l.height);return t.readRenderTargetPixels(l,0,0,l.width,l.height,c),l.dispose(),d.geometry.dispose(),d.material.dispose(),ur=c[0]!==0,ur};class Rr{constructor(t){ce(this,"_renderer");ce(this,"_rendererIsDisposable",!1);ce(this,"_material");ce(this,"_scene");ce(this,"_camera");ce(this,"_quad");ce(this,"_renderTarget");ce(this,"_width");ce(this,"_height");ce(this,"_type");ce(this,"_colorSpace");ce(this,"_supportsReadPixels",!0);ce(this,"render",()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(t){throw this._renderer.setRenderTarget(null),t}this._renderer.setRenderTarget(null)});var o,l,d,c,w,p,g,b,C,T,O,N,le,H,q,te;this._width=t.width,this._height=t.height,this._type=t.type,this._colorSpace=t.colorSpace;const a={format:nr,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:((o=t.renderTargetOptions)==null?void 0:o.anisotropy)!==void 0?(l=t.renderTargetOptions)==null?void 0:l.anisotropy:1,generateMipmaps:((d=t.renderTargetOptions)==null?void 0:d.generateMipmaps)!==void 0?(c=t.renderTargetOptions)==null?void 0:c.generateMipmaps:!1,magFilter:((w=t.renderTargetOptions)==null?void 0:w.magFilter)!==void 0?(p=t.renderTargetOptions)==null?void 0:p.magFilter:Ae,minFilter:((g=t.renderTargetOptions)==null?void 0:g.minFilter)!==void 0?(b=t.renderTargetOptions)==null?void 0:b.minFilter:Ae,samples:((C=t.renderTargetOptions)==null?void 0:C.samples)!==void 0?(T=t.renderTargetOptions)==null?void 0:T.samples:void 0,wrapS:((O=t.renderTargetOptions)==null?void 0:O.wrapS)!==void 0?(N=t.renderTargetOptions)==null?void 0:N.wrapS:Pe,wrapT:((le=t.renderTargetOptions)==null?void 0:le.wrapT)!==void 0?(H=t.renderTargetOptions)==null?void 0:H.wrapT:Pe};if(this._material=t.material,t.renderer?this._renderer=t.renderer:(this._renderer=Rr.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new Xr,this._camera=new jt,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!Ta(this._type,this._renderer,this._camera,a)){let ue;switch(this._type){case Ie:ue=this._renderer.extensions.has("EXT_color_buffer_float")?Be:void 0;break}ue!==void 0?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${Be}`),this._type=ue):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new br(new Yr,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new Vr(this.width,this.height,a),this._renderTarget.texture.mapping=((q=t.renderTargetOptions)==null?void 0:q.mapping)!==void 0?(te=t.renderTargetOptions)==null?void 0:te.mapping:dr}static instantiateRenderer(){const t=new $t;return t.setSize(128,128),t}toArray(){if(!this._supportsReadPixels)throw new Error("Can't read pixels in this browser");const t=at(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,t),t}toDataTexture(t){const a=new Xt(this.toArray(),this.width,this.height,nr,this._type,(t==null?void 0:t.mapping)||dr,(t==null?void 0:t.wrapS)||Pe,(t==null?void 0:t.wrapT)||Pe,(t==null?void 0:t.magFilter)||Ae,(t==null?void 0:t.minFilter)||Ae,(t==null?void 0:t.anisotropy)||1,Er);return a.generateMipmaps=(t==null?void 0:t.generateMipmaps)!==void 0?t==null?void 0:t.generateMipmaps:!1,a}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(t){this.disposeOnDemandRenderer(),t&&this.renderTarget.dispose(),this.material instanceof Tr&&Object.values(this.material.uniforms).forEach(a=>{a.value instanceof je&&a.value.dispose()}),Object.values(this.material).forEach(a=>{a instanceof je&&a.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(t){this._width=t,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(t){this._height=t,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(t){this._renderTarget=t,this._width=t.width,this._height=t.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}class nt extends Error{}class it extends Error{}const tr=(i,t,a)=>{const o=new RegExp(`${t}="([^"]*)"`,"i").exec(i);if(o)return o[1];const l=new RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i").exec(i);if(l){const d=l[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return d&&d.length===3?d.map(c=>c.replace(/<\/?rdf:li>/g,"")):l[1].trim()}if(a!==void 0)return a;throw new Error(`Can't find ${t} in gainmap metadata`)},Ra=i=>{let t;typeof TextDecoder<"u"?t=new TextDecoder().decode(i):t=i.toString();let a=t.indexOf("<x:xmpmeta");for(;a!==-1;){const o=t.indexOf("x:xmpmeta>",a),l=t.slice(a,o+10);try{const d=tr(l,"hdrgm:GainMapMin","0"),c=tr(l,"hdrgm:GainMapMax"),w=tr(l,"hdrgm:Gamma","1"),p=tr(l,"hdrgm:OffsetSDR","0.015625"),g=tr(l,"hdrgm:OffsetHDR","0.015625"),b=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(l),C=b?b[1]:"0",T=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(l);if(!T)throw new Error("Incomplete gainmap metadata");const O=T[1];return{gainMapMin:Array.isArray(d)?d.map(N=>parseFloat(N)):[parseFloat(d),parseFloat(d),parseFloat(d)],gainMapMax:Array.isArray(c)?c.map(N=>parseFloat(N)):[parseFloat(c),parseFloat(c),parseFloat(c)],gamma:Array.isArray(w)?w.map(N=>parseFloat(N)):[parseFloat(w),parseFloat(w),parseFloat(w)],offsetSdr:Array.isArray(p)?p.map(N=>parseFloat(N)):[parseFloat(p),parseFloat(p),parseFloat(p)],offsetHdr:Array.isArray(g)?g.map(N=>parseFloat(N)):[parseFloat(g),parseFloat(g),parseFloat(g)],hdrCapacityMin:parseFloat(C),hdrCapacityMax:parseFloat(O)}}catch{}a=t.indexOf("<x:xmpmeta",o)}};class Ca{constructor(t){ce(this,"options");this.options={debug:t&&t.debug!==void 0?t.debug:!1,extractFII:t&&t.extractFII!==void 0?t.extractFII:!0,extractNonFII:t&&t.extractNonFII!==void 0?t.extractNonFII:!0}}extract(t){return new Promise((a,o)=>{const l=this.options.debug,d=new DataView(t.buffer);if(d.getUint16(0)!==65496){o(new Error("Not a valid jpeg"));return}const c=d.byteLength;let w=2,p=0,g;for(;w<c;){if(++p>250){o(new Error(`Found no marker after ${p} loops ðŸ˜µ`));return}if(d.getUint8(w)!==255){o(new Error(`Not a valid marker at offset 0x${w.toString(16)}, found: 0x${d.getUint8(w).toString(16)}`));return}if(g=d.getUint8(w+1),l&&console.log(`Marker: ${g.toString(16)}`),g===226){l&&console.log("Found APP2 marker (0xffe2)");const b=w+4;if(d.getUint32(b)===1297106432){const C=b+4;let T;if(d.getUint16(C)===18761)T=!1;else if(d.getUint16(C)===19789)T=!0;else{o(new Error("No valid endianness marker found in TIFF header"));return}if(d.getUint16(C+2,!T)!==42){o(new Error("Not valid TIFF data! (no 0x002A marker)"));return}const O=d.getUint32(C+4,!T);if(O<8){o(new Error("Not valid TIFF data! (First offset less than 8)"));return}const N=C+O,le=d.getUint16(N,!T),H=N+2;let q=0;for(let Z=H;Z<H+12*le;Z+=12)d.getUint16(Z,!T)===45057&&(q=d.getUint32(Z+8,!T));const ue=N+2+le*12+4,he=[];for(let Z=ue;Z<ue+q*16;Z+=16){const D={MPType:d.getUint32(Z,!T),size:d.getUint32(Z+4,!T),dataOffset:d.getUint32(Z+8,!T),dependantImages:d.getUint32(Z+12,!T),start:-1,end:-1,isFII:!1};D.dataOffset?(D.start=C+D.dataOffset,D.isFII=!1):(D.start=0,D.isFII=!0),D.end=D.start+D.size,he.push(D)}if(this.options.extractNonFII&&he.length){const Z=new Blob([d]),D=[];for(const ae of he){if(ae.isFII&&!this.options.extractFII)continue;const M=Z.slice(ae.start,ae.end+1,"image/jpeg");D.push(M)}a(D)}}}w+=2+d.getUint16(w+2)}})}}const Aa=async i=>{const t=Ra(i);if(!t)throw new it("Gain map XMP metadata not found");const o=await new Ca({extractFII:!0,extractNonFII:!0}).extract(i);if(o.length!==2)throw new nt("Gain map recovery image not found");return{sdr:new Uint8Array(await o[0].arrayBuffer()),gainMap:new Uint8Array(await o[1].arrayBuffer()),metadata:t}},jr=i=>new Promise((t,a)=>{const o=document.createElement("img");o.onload=()=>{t(o)},o.onerror=l=>{a(l)},o.src=URL.createObjectURL(i)});class Fa extends Jt{constructor(a,o){super(o);ce(this,"_renderer");ce(this,"_renderTargetOptions");ce(this,"_internalLoadingManager");ce(this,"_config");this._config=a,a.renderer&&(this._renderer=a.renderer),this._internalLoadingManager=new ea}setRenderer(a){return this._renderer=a,this}setRenderTargetOptions(a){return this._renderTargetOptions=a,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: A Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");const a=this._config.createMaterial({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new je,sdr:new je});return this._config.createQuadRenderer({width:16,height:16,type:Ie,colorSpace:Er,material:a,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async processImages(a,o,l){const d=o?new Blob([o],{type:"image/jpeg"}):void 0,c=new Blob([a],{type:"image/jpeg"});let w,p,g=!1;if(typeof createImageBitmap>"u"){const b=await Promise.all([d?jr(d):Promise.resolve(void 0),jr(c)]);p=b[0],w=b[1],g=l==="flipY"}else{const b=await Promise.all([d?createImageBitmap(d,{imageOrientation:l||"flipY"}):Promise.resolve(void 0),createImageBitmap(c,{imageOrientation:l||"flipY"})]);p=b[0],w=b[1]}return{sdrImage:w,gainMapImage:p,needsFlip:g}}createTextures(a,o,l){const d=new je(o||new ImageData(2,2),dr,Pe,Pe,Ae,Zr,nr,Mr,1,Er);d.flipY=l,d.needsUpdate=!0;const c=new je(a,dr,Pe,Pe,Ae,Zr,nr,Mr,1,ra);return c.flipY=l,c.needsUpdate=!0,{gainMap:d,sdr:c}}updateQuadRenderer(a,o,l,d,c){a.width=o.width,a.height=o.height,a.material.gainMap=l,a.material.sdr=d,a.material.gainMapMin=c.gainMapMin,a.material.gainMapMax=c.gainMapMax,a.material.offsetHdr=c.offsetHdr,a.material.offsetSdr=c.offsetSdr,a.material.gamma=c.gamma,a.material.hdrCapacityMin=c.hdrCapacityMin,a.material.hdrCapacityMax=c.hdrCapacityMax,a.material.maxDisplayBoost=Math.pow(2,c.hdrCapacityMax),a.material.needsUpdate=!0}}const Ua=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,Oa=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class Na extends Tr{constructor({gamma:a,offsetHdr:o,offsetSdr:l,gainMapMin:d,gainMapMax:c,maxDisplayBoost:w,hdrCapacityMin:p,hdrCapacityMax:g,sdr:b,gainMap:C}){super({name:"GainMapDecoderMaterial",vertexShader:Ua,fragmentShader:Oa,uniforms:{sdr:{value:b},gainMap:{value:C},gamma:{value:new er(1/a[0],1/a[1],1/a[2])},offsetHdr:{value:new er().fromArray(o)},offsetSdr:{value:new er().fromArray(l)},gainMapMin:{value:new er().fromArray(d)},gainMapMax:{value:new er().fromArray(c)},weightFactor:{value:(Math.log2(w)-p)/(g-p)}},blending:ta,depthTest:!1,depthWrite:!1});ce(this,"_maxDisplayBoost");ce(this,"_hdrCapacityMin");ce(this,"_hdrCapacityMax");this._maxDisplayBoost=w,this._hdrCapacityMin=p,this._hdrCapacityMax=g,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(a){this.uniforms.sdr.value=a}get gainMap(){return this.uniforms.gainMap.value}set gainMap(a){this.uniforms.gainMap.value=a}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(a){this.uniforms.offsetHdr.value.fromArray(a)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(a){this.uniforms.offsetSdr.value.fromArray(a)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(a){this.uniforms.gainMapMin.value.fromArray(a)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(a){this.uniforms.gainMapMax.value.fromArray(a)}get gamma(){const a=this.uniforms.gamma.value;return[1/a.x,1/a.y,1/a.z]}set gamma(a){const o=this.uniforms.gamma.value;o.x=1/a[0],o.y=1/a[1],o.z=1/a[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(a){this._hdrCapacityMin=a,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(a){this._hdrCapacityMax=a,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(a){this._maxDisplayBoost=Math.max(1,Math.min(65504,a)),this.calculateWeight()}calculateWeight(){const a=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,a))}}class st extends Fa{constructor(t,a){super({renderer:t,createMaterial:o=>new Na(o),createQuadRenderer:o=>new Rr(o)},a)}async render(t,a,o,l){const{sdrImage:d,gainMapImage:c,needsFlip:w}=await this.processImages(o,l,"flipY"),{gainMap:p,sdr:g}=this.createTextures(d,c,w);this.updateQuadRenderer(t,d,p,g,a),t.render()}}class Ba extends st{load([t,a,o],l,d,c){const w=this.prepareQuadRenderer();let p,g,b;const C=async()=>{if(p&&g&&b){try{await this.render(w,b,p,g)}catch(I){this.manager.itemError(t),this.manager.itemError(a),this.manager.itemError(o),typeof c=="function"&&c(I),w.disposeOnDemandRenderer();return}typeof l=="function"&&l(w),this.manager.itemEnd(t),this.manager.itemEnd(a),this.manager.itemEnd(o),w.disposeOnDemandRenderer()}};let T=!0,O=0,N=0,le=!0,H=0,q=0,te=!0,ue=0,he=0;const Z=()=>{if(typeof d=="function"){const I=O+H+ue,G=N+q+he,$=T&&le&&te;d(new ProgressEvent("progress",{lengthComputable:$,loaded:G,total:I}))}};this.manager.itemStart(t),this.manager.itemStart(a),this.manager.itemStart(o);const D=new hr(this._internalLoadingManager);D.setResponseType("arraybuffer"),D.setRequestHeader(this.requestHeader),D.setPath(this.path),D.setWithCredentials(this.withCredentials),D.load(t,async I=>{if(typeof I=="string")throw new Error("Invalid sdr buffer");p=I,await C()},I=>{T=I.lengthComputable,N=I.loaded,O=I.total,Z()},I=>{this.manager.itemError(t),typeof c=="function"&&c(I)});const ae=new hr(this._internalLoadingManager);ae.setResponseType("arraybuffer"),ae.setRequestHeader(this.requestHeader),ae.setPath(this.path),ae.setWithCredentials(this.withCredentials),ae.load(a,async I=>{if(typeof I=="string")throw new Error("Invalid gainmap buffer");g=I,await C()},I=>{le=I.lengthComputable,q=I.loaded,H=I.total,Z()},I=>{this.manager.itemError(a),typeof c=="function"&&c(I)});const M=new hr(this._internalLoadingManager);return M.setRequestHeader(this.requestHeader),M.setPath(this.path),M.setWithCredentials(this.withCredentials),M.load(o,async I=>{if(typeof I!="string")throw new Error("Invalid metadata string");b=JSON.parse(I),await C()},I=>{te=I.lengthComputable,he=I.loaded,ue=I.total,Z()},I=>{this.manager.itemError(o),typeof c=="function"&&c(I)}),w}}class Da extends st{load(t,a,o,l){const d=this.prepareQuadRenderer(),c=new hr(this._internalLoadingManager);return c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setPath(this.path),c.setWithCredentials(this.withCredentials),this.manager.itemStart(t),c.load(t,async w=>{if(typeof w=="string")throw new Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");const p=new Uint8Array(w);let g,b,C;try{const T=await Aa(p);g=T.sdr,b=T.gainMap,C=T.metadata}catch(T){if(T instanceof it||T instanceof nt)console.warn(`Failure to reconstruct an HDR image from ${t}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),C={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},g=p;else throw T}try{await this.render(d,C,g.buffer,b==null?void 0:b.buffer)}catch(T){this.manager.itemError(t),typeof l=="function"&&l(T),d.disposeOnDemandRenderer();return}typeof a=="function"&&a(d),this.manager.itemEnd(t),d.disposeOnDemandRenderer()},o,w=>{this.manager.itemError(t),typeof l=="function"&&l(w)}),d}}const ir={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},ot="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",$e=i=>Array.isArray(i),Cr=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function fr({files:i=Cr,path:t="",preset:a=void 0,colorSpace:o=void 0,extensions:l}={}){a&&(Ar(a),i=ir[a],t=ot);const d=$e(i),{extension:c,isCubemap:w}=Fr(i),p=Ur(c);if(!p)throw new Error("useEnvironment: Unrecognized file extension: "+i);const g=Xe(O=>O.gl);k.useLayoutEffect(()=>{if(c!=="webp"&&c!=="jpg"&&c!=="jpeg")return;function O(){pr.clear(p,d?[i]:i)}g.domElement.addEventListener("webglcontextlost",O,{once:!0})},[i,g.domElement]);const b=pr(p,d?[i]:i,O=>{(c==="webp"||c==="jpg"||c==="jpeg")&&O.setRenderer(g),O.setPath==null||O.setPath(t),l&&l(O)});let C=d?b[0]:b;if(c==="jpg"||c==="jpeg"||c==="webp"){var T;C=(T=C.renderTarget)==null?void 0:T.texture}return C.mapping=w?aa:na,C.colorSpace=o??(w?"srgb":"srgb-linear"),C}const La={files:Cr,path:"",preset:void 0,extensions:void 0};fr.preload=i=>{const t={...La,...i};let{files:a,path:o=""}=t;const{preset:l,extensions:d}=t;l&&(Ar(l),a=ir[l],o=ot);const{extension:c}=Fr(a);if(c==="webp"||c==="jpg"||c==="jpeg")throw new Error("useEnvironment: Preloading gainmaps is not supported");const w=Ur(c);if(!w)throw new Error("useEnvironment: Unrecognized file extension: "+a);pr.preload(w,$e(a)?[a]:a,p=>{p.setPath==null||p.setPath(o),d&&d(p)})};const ka={files:Cr,preset:void 0};fr.clear=i=>{const t={...ka,...i};let{files:a}=t;const{preset:o}=t;o&&(Ar(o),a=ir[o]);const{extension:l}=Fr(a),d=Ur(l);if(!d)throw new Error("useEnvironment: Unrecognized file extension: "+a);pr.clear(d,$e(a)?[a]:a)};function Ar(i){if(!(i in ir))throw new Error("Preset must be one of: "+Object.keys(ir).join(", "))}function Fr(i){var t;const a=$e(i)&&i.length===6,o=$e(i)&&i.length===3&&i.some(c=>c.endsWith("json")),l=$e(i)?i[0]:i;return{extension:a?"cube":o?"webp":l.startsWith("data:application/exr")?"exr":l.startsWith("data:application/hdr")?"hdr":l.startsWith("data:image/jpeg")?"jpg":(t=l.split(".").pop())==null||(t=t.split("?"))==null||(t=t.shift())==null?void 0:t.toLowerCase(),isCubemap:a,isGainmap:o}}function Ur(i){return i==="cube"?ia:i==="hdr"?xa:i==="exr"?ba:i==="jpg"||i==="jpeg"?Da:i==="webp"?Ba:null}const Pa=i=>i.current&&i.current.isScene,Ha=i=>Pa(i)?i.current:i;function Or(i,t,a,o,l={}){var d,c,w,p;l={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...l};const g=Ha(t||a),b=g.background,C=g.environment,T={backgroundBlurriness:g.backgroundBlurriness,backgroundIntensity:g.backgroundIntensity,backgroundRotation:(d=(c=g.backgroundRotation)==null||c.clone==null?void 0:c.clone())!==null&&d!==void 0?d:[0,0,0],environmentIntensity:g.environmentIntensity,environmentRotation:(w=(p=g.environmentRotation)==null||p.clone==null?void 0:p.clone())!==null&&w!==void 0?w:[0,0,0]};return i!=="only"&&(g.environment=o),i&&(g.background=o),Wr(g,l),()=>{i!=="only"&&(g.environment=C),i&&(g.background=b),Wr(g,T)}}function Nr({scene:i,background:t=!1,map:a,...o}){const l=Xe(d=>d.scene);return k.useLayoutEffect(()=>{if(a)return Or(t,i,l,a,o)}),null}function lt({background:i=!1,scene:t,blur:a,backgroundBlurriness:o,backgroundIntensity:l,backgroundRotation:d,environmentIntensity:c,environmentRotation:w,...p}){const g=fr(p),b=Xe(C=>C.scene);return k.useLayoutEffect(()=>Or(i,t,b,g,{backgroundBlurriness:a??o,backgroundIntensity:l,backgroundRotation:d,environmentIntensity:c,environmentRotation:w})),k.useEffect(()=>()=>{g.dispose()},[g]),null}function za({children:i,near:t=.1,far:a=1e3,resolution:o=256,frames:l=1,map:d,background:c=!1,blur:w,backgroundBlurriness:p,backgroundIntensity:g,backgroundRotation:b,environmentIntensity:C,environmentRotation:T,scene:O,files:N,path:le,preset:H=void 0,extensions:q}){const te=Xe(M=>M.gl),ue=Xe(M=>M.scene),he=k.useRef(null),[Z]=k.useState(()=>new Xr),D=k.useMemo(()=>{const M=new oa(o);return M.texture.type=Ie,M},[o]);k.useEffect(()=>()=>{D.dispose()},[D]),k.useLayoutEffect(()=>{if(l===1){const M=te.autoClear;te.autoClear=!0,he.current.update(te,Z),te.autoClear=M}return Or(c,O,ue,D.texture,{backgroundBlurriness:w??p,backgroundIntensity:g,backgroundRotation:b,environmentIntensity:C,environmentRotation:T})},[i,Z,D.texture,O,ue,c,l,te]);let ae=1;return vr(()=>{if(l===1/0||ae<l){const M=te.autoClear;te.autoClear=!0,he.current.update(te,Z),te.autoClear=M,ae++}}),k.createElement(k.Fragment,null,la(k.createElement(k.Fragment,null,i,k.createElement("cubeCamera",{ref:he,args:[t,a,D]}),N||H?k.createElement(lt,{background:!0,files:N,preset:H,path:le,extensions:q}):d?k.createElement(Nr,{background:!0,map:d,extensions:q}):null),Z))}function Ga(i){var t,a,o,l;const d=fr(i),c=i.map||d;k.useMemo(()=>sa({GroundProjectedEnvImpl:Ia}),[]),k.useEffect(()=>()=>{d.dispose()},[d]);const w=k.useMemo(()=>[c],[c]),p=(t=i.ground)==null?void 0:t.height,g=(a=i.ground)==null?void 0:a.radius,b=(o=(l=i.ground)==null?void 0:l.scale)!==null&&o!==void 0?o:1e3;return k.createElement(k.Fragment,null,k.createElement(Nr,Sr({},i,{map:c})),k.createElement("groundProjectedEnvImpl",{args:w,scale:b,height:p,radius:g}))}function Za(i){return i.ground?k.createElement(Ga,i):i.map?k.createElement(Nr,i):i.children?k.createElement(za,i):k.createElement(lt,i)}const wr=350,yr=24,Ne=new ca;function Wa(){const i=k.useRef(),t=k.useRef({x:0,y:0}),{viewport:a}=Xe(),o=k.useMemo(()=>{const l=[];for(let d=0;d<wr;d++)l.push({position:[(Math.random()-.5)*yr,(Math.random()-.5)*yr*.8,(Math.random()-.5)*yr],speed:.1+Math.random()*.35,offset:Math.random()*Math.PI*2,scale:.02+Math.random()*.1,rotSpeed:(Math.random()-.5)*.015});return l},[]);return vr(l=>{if(!i.current)return;const d=l.clock.elapsedTime,c=l.pointer;t.current.x+=(c.x*a.width*.5-t.current.x)*.03,t.current.y+=(c.y*a.height*.5-t.current.y)*.03;for(let w=0;w<wr;w++){const p=o[w],g=p.position[0]+Math.sin(d*p.speed+p.offset)*1.2,b=p.position[1]+Math.cos(d*p.speed*.6+p.offset)*.8,C=p.position[2]+Math.sin(d*p.speed*.4+p.offset*2)*.6,T=g-t.current.x,O=b-t.current.y,N=Math.sqrt(T*T+O*O),le=Math.max(0,4-N)*.2,H=N>.01?T/N*le:0,q=N>.01?O/N*le:0;Ne.position.set(g+H,b+q,C),Ne.rotation.set(d*p.rotSpeed+p.offset,d*p.rotSpeed*1.4,d*p.rotSpeed*.6),Ne.scale.setScalar(p.scale),Ne.updateMatrix(),i.current.setMatrixAt(w,Ne.matrix)}i.current.instanceMatrix.needsUpdate=!0}),P.jsxs("instancedMesh",{ref:i,args:[null,null,wr],frustumCulled:!1,children:[P.jsx("icosahedronGeometry",{args:[1,1]}),P.jsx("meshPhysicalMaterial",{color:"#1a1a2e",roughness:.75,metalness:.15,transmission:.05,thickness:.5,envMapIntensity:.2,transparent:!0,opacity:.9})]})}function ja(){const i=k.useRef(),t=120,a=k.useMemo(()=>{const o=[];for(let l=0;l<t;l++)o.push({position:[(Math.random()-.5)*30,(Math.random()-.5)*20,(Math.random()-.5)*30],speed:.05+Math.random()*.15,offset:Math.random()*Math.PI*2,scale:.008+Math.random()*.015});return o},[]);return vr(o=>{if(!i.current)return;const l=o.clock.elapsedTime;for(let d=0;d<t;d++){const c=a[d];Ne.position.set(c.position[0]+Math.sin(l*c.speed+c.offset)*.5,c.position[1]+Math.cos(l*c.speed*.8+c.offset)*.4,c.position[2]+Math.sin(l*c.speed*.3+c.offset*1.5)*.3),Ne.scale.setScalar(c.scale),Ne.updateMatrix(),i.current.setMatrixAt(d,Ne.matrix)}i.current.instanceMatrix.needsUpdate=!0}),P.jsxs("instancedMesh",{ref:i,args:[null,null,t],frustumCulled:!1,children:[P.jsx("sphereGeometry",{args:[1,8,8]}),P.jsx("meshBasicMaterial",{color:"#4a5568",transparent:!0,opacity:.4})]})}function $a(){const i=k.useRef(),t=k.useRef(),a=k.useRef();return vr(o=>{const l=o.clock.elapsedTime;i.current&&(i.current.rotation.x=l*.02,i.current.rotation.z=l*.015),t.current&&(t.current.rotation.y=l*.025,t.current.rotation.x=l*.01),a.current&&(a.current.rotation.z=l*.018,a.current.rotation.y=l*.012)}),P.jsxs(P.Fragment,{children:[P.jsxs("mesh",{ref:i,position:[6,3,-8],children:[P.jsx("torusGeometry",{args:[3,.01,8,64]}),P.jsx("meshBasicMaterial",{color:"#2a2a3a",transparent:!0,opacity:.15})]}),P.jsxs("mesh",{ref:t,position:[-7,-2,-10],children:[P.jsx("torusGeometry",{args:[4,.01,8,64]}),P.jsx("meshBasicMaterial",{color:"#1e293b",transparent:!0,opacity:.1})]}),P.jsxs("mesh",{ref:a,position:[0,5,-12],children:[P.jsx("torusGeometry",{args:[5,.005,8,96]}),P.jsx("meshBasicMaterial",{color:"#334155",transparent:!0,opacity:.08})]})]})}function Xa(){return P.jsxs(P.Fragment,{children:[P.jsx("ambientLight",{intensity:.12,color:"#94a3b8"}),P.jsx("directionalLight",{position:[5,8,5],intensity:.4,color:"#e2e8f0"}),P.jsx("directionalLight",{position:[-5,-3,-5],intensity:.12,color:"#64748b"}),P.jsx("pointLight",{position:[0,0,8],intensity:.15,color:"#cbd5e1",distance:25}),P.jsx("pointLight",{position:[-8,4,-5],intensity:.08,color:"#94a3b8",distance:20}),P.jsx("pointLight",{position:[8,-4,-3],intensity:.06,color:"#475569",distance:15})]})}function qa(){return P.jsxs(P.Fragment,{children:[P.jsx("fog",{attach:"fog",args:["#0a0a0a",4,28]}),P.jsx(Xa,{}),P.jsx(Wa,{}),P.jsx(ja,{}),P.jsx($a,{}),P.jsx(Za,{preset:"city",environmentIntensity:.04})]})}export{qa as default};
